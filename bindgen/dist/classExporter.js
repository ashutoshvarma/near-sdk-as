"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClassExporter = void 0;
const as_1 = require("visitor-as/as");
const visitor_as_1 = require("visitor-as");
const JSONBuilder_1 = require("./JSONBuilder");
const utils_1 = require("./utils");
const toString = visitor_as_1.utils.toString;
class ClassExporter extends visitor_as_1.ClassDecorator {
    constructor() {
        super(...arguments);
        this.sb = [];
    }
    static get className() {
        return toString(ClassExporter.classSeen.name);
    }
    checkMethods(name) {
        let _class = ClassExporter.classSeen;
        _class.members.forEach((member) => {
            if (member instanceof as_1.MethodDeclaration &&
                !member.is(as_1.CommonFlags.PRIVATE)) {
                if (toString(member.name) === name) {
                    throw new Error(`Method "${toString(member.name)}" already used cannot export constructor using the same name.`);
                }
            }
        });
    }
    visitFieldDeclaration(node) { }
    visitMethodDeclaration(node) {
        if (node.is(as_1.CommonFlags.SET) || node.is(as_1.CommonFlags.GET)) {
            throw new Error("Exported Singleton class cannot have properties. Found " +
                node.name.text);
        }
        // Private methods should be skipped.
        if (node.is(as_1.CommonFlags.PRIVATE)) {
            return;
        }
        let name = toString(node.name);
        let decorators = (node.decorators || []).map(toString);
        let returnType = toString(node.signature.returnType);
        let origParams = node.signature.parameters.map(visitor_as_1.utils.cloneNode);
        let parameters = origParams.map((param) => {
            if (param.implicitFieldDeclaration) {
                param.name.text = param.name.text.substring(2);
            }
            return toString(param);
        });
        let pramNames = origParams.map((param) => {
            return toString(param.name);
        });
        let isInit = name === "constructor";
        let assertStr = isInit
            ? `assert(isNull(__contract), "contract is already initialized");`
            : `assert(!isNull(__contract), "contract is not initialized");`;
        let isVoid = returnType === "void";
        let body = isInit
            ? `__contract = new ${ClassExporter.className}(${pramNames.join(", ")});`
            : `${!isVoid ? "let res =  " : ""}__contract.${name}(${pramNames.join(", ")});`;
        if (isInit) {
            name = "init";
            parameters = origParams.map((node) => `${toString(node.name)}: ${toString(node.type)}${node.initializer ? " = " + toString(node.initializer) : ""}`);
            returnType = "void";
        }
        if (isInit) {
            if (!decorators.some((decorator) => decorator.includes("exportAs"))) {
                decorators.push(`@exportAs("new")`);
                this.checkMethods("new");
            }
            else {
                let decorator = node.decorators.find((d) => toString(d.name) === "exportAs");
                if (decorator.args.length == 1) {
                    this.checkMethods(toString(decorator.args[0]));
                }
            }
        }
        const hasUpdateState = decorators.some((decorator) => {
            let res = decorator.includes("updateState");
            return res;
        });
        this.sb.push(`${decorators.join("\n")}
export function ${name}(${parameters.join(", ")}): ${returnType} {
  ${assertStr}
  ${body}
  ${isInit || hasUpdateState ? `__setState(__contract);` : ""}
  ${isVoid || isInit ? "" : "return res;"}
}`);
    }
    visitClassDeclaration(node) {
        if (JSONBuilder_1.isEntry(node) && node.is(as_1.CommonFlags.EXPORT)) {
            let name = toString(node.name);
            if (ClassExporter.classSeen) {
                throw new Error(`Cannot export class ${name}. ${ClassExporter.className} already exported. `);
            }
            ClassExporter.classSeen = node;
            this.sb.push(`let __contract: ${name};
if (__checkState()) {
  __contract = __getState<${name}>();
}`);
            this.visit(node.members);
            node.flags = node.flags ^ as_1.CommonFlags.EXPORT;
            let newStatements = utils_1.SimpleParser.parseTopLevel(this.sb.join("\n")).map((n) => {
                if (n instanceof as_1.FunctionDeclaration) {
                    n.flags = n.flags | as_1.CommonFlags.EXPORT;
                    n.flags = n.flags | as_1.CommonFlags.MODULE_EXPORT;
                }
                n.range = node.range;
                return n;
            });
            node.range.source.statements.push(...newStatements);
        }
    }
    get name() {
        return "nearBindgen";
    }
    static visit(source) {
        if (source.sourceKind != as_1.SourceKind.USER_ENTRY) {
            return;
        }
        let visitor = new ClassExporter();
        visitor.visit(source);
    }
}
exports.ClassExporter = ClassExporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xhc3NFeHBvcnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGFzc0V4cG9ydGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHNDQVF1QjtBQUN2QiwyQ0FBbUQ7QUFDbkQsK0NBQXdDO0FBQ3hDLG1DQUF1QztBQUV2QyxNQUFNLFFBQVEsR0FBRyxrQkFBSyxDQUFDLFFBQVEsQ0FBQztBQUVoQyxNQUFhLGFBQWMsU0FBUSwyQkFBYztJQUFqRDs7UUFDRSxPQUFFLEdBQWEsRUFBRSxDQUFDO0lBOElwQixDQUFDO0lBM0lDLE1BQU0sS0FBSyxTQUFTO1FBQ2xCLE9BQU8sUUFBUSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVELFlBQVksQ0FBQyxJQUFZO1FBQ3ZCLElBQUksTUFBTSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUM7UUFDckMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUNoQyxJQUNFLE1BQU0sWUFBWSxzQkFBaUI7Z0JBQ25DLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxnQkFBVyxDQUFDLE9BQU8sQ0FBQyxFQUMvQjtnQkFDQSxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO29CQUNsQyxNQUFNLElBQUksS0FBSyxDQUNiLFdBQVcsUUFBUSxDQUNqQixNQUFNLENBQUMsSUFBSSxDQUNaLCtEQUErRCxDQUNqRSxDQUFDO2lCQUNIO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxJQUFzQixJQUFTLENBQUM7SUFFdEQsc0JBQXNCLENBQUMsSUFBdUI7UUFDNUMsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFDLGdCQUFXLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxnQkFBVyxDQUFDLEdB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QyxVQUFVLEVBQUU7WUFDOUMsT0FBTztTQUNSO1FBQ0QsSUFBSSxPQUFPLEdBQUcsSUFBSSxhQUFhLEVBQUUsQ0FBQztRQUNsQyxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hCLENBQUM7Q0FDRjtBQS9JRCxzQ0ErSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDbGFzc0RlY2xhcmF0aW9uLFxuICBGaWVsZERlY2xhcmF0aW9uLFxuICBNZXRob2REZWNsYXJhdGlvbixcbiAgU291cmNlLFxuICBDb21tb25GbGFncyxcbiAgU291cmNlS2luZCxcbiAgRnVuY3Rpb25EZWNsYXJhdGlvbixcbn0gZnJvbSBcInZpc2l0b3ItYXMvYXNcIjtcbmltcG9ydCB7IHV0aWxzLCBDbGFzc0RlY29yYXRvciB9IGZyb20gXCJ2aXNpdG9yLWFzXCI7XG5pbXBvcnQgeyBpc0VudHJ5IH0gZnJvbSBcIi4vSlNPTkJ1aWxkZXJcIjtcbmltcG9ydCB7IFNpbXBsZVBhcnNlciB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmNvbnN0IHRvU3RyaW5nID0gdXRpbHMudG9TdHJpbmc7XG5cbmV4cG9ydCBjbGFzcyBDbGFzc0V4cG9ydGVyIGV4dGVuZHMgQ2xhc3NEZWNvcmF0b3Ige1xuICBzYjogc3RyaW5nW10gPSBbXTtcbiAgc3RhdGljIGNsYXNzU2VlbjogQ2xhc3NEZWNsYXJhdGlvbjtcblxuICBzdGF0aWMgZ2V0IGNsYXNzTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0b1N0cmluZyhDbGFzc0V4cG9ydGVyLmNsYXNzU2Vlbi5uYW1lKTtcbiAgfVxuXG4gIGNoZWNrTWV0aG9kcyhuYW1lOiBzdHJpbmcpIHtcbiAgICBsZXQgX2NsYXNzID0gQ2xhc3NFeHBvcnRlci5jbGFzc1NlZW47XG4gICAgX2NsYXNzLm1lbWJlcnMuZm9yRWFjaCgobWVtYmVyKSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIG1lbWJlciBpbnN0YW5jZW9mIE1ldGhvZERlY2xhcmF0aW9uICYmXG4gICAgICAgICFtZW1iZXIuaXMoQ29tbW9uRmxhZ3MuUFJJVkFURSlcbiAgICAgICkge1xuICAgICAgICBpZiAodG9TdHJpbmcobWVtYmVyLm5hbWUpID09PSBuYW1lKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYE1ldGhvZCBcIiR7dG9TdHJpbmcoXG4gICAgICAgICAgICAgIG1lbWJlci5uYW1lXG4gICAgICAgICAgICApfVwiIGFscmVhZHkgdXNlZCBjYW5ub3QgZXhwb3J0IGNvbnN0cnVjdG9yIHVzaW5nIHRoZSBzYW1lIG5hbWUuYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHZpc2l0RmllbGREZWNsYXJhdGlvbihub2RlOiBGaWVsZERlY2xhcmF0aW9uKTogdm9pZCB7fVxuXG4gIHZpc2l0TWV0aG9kRGVjbGFyYXRpb24obm9kZTogTWV0aG9kRGVjbGFyYXRpb24pOiB2b2lkIHtcbiAgICBpZiAobm9kZS5pcyhDb21tb25GbGFncy5TRVQpIHx8IG5vZGUuaXMoQ29tbW9uRmxhZ3MuR0VUKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIkV4cG9ydGVkIFNpbmdsZXRvbiBjbGFzcyBjYW5ub3QgaGF2ZSBwcm9wZXJ0aWVzLiBGb3VuZCBcIiArXG4gICAgICAgICAgbm9kZS5uYW1lLnRleHRcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIFByaXZhdGUgbWV0aG9kcyBzaG91bGQgYmUgc2tpcHBlZC5cbiAgICBpZiAobm9kZS5pcyhDb21tb25GbGFncy5QUklWQVRFKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgbmFtZSA9IHRvU3RyaW5nKG5vZGUubmFtZSk7XG4gICAgbGV0IGRlY29yYXRvcnMgPSAobm9kZS5kZWNvcmF0b3JzIHx8IFtdKS5tYXAodG9TdHJpbmcpO1xuICAgIGxldCByZXR1cm5UeXBlID0gdG9TdHJpbmcobm9kZS5zaWduYXR1cmUucmV0dXJuVHlwZSk7XG4gICAgbGV0IG9yaWdQYXJhbXMgPSBub2RlLnNpZ25hdHVyZS5wYXJhbWV0ZXJzLm1hcCh1dGlscy5jbG9uZU5vZGUpO1xuICAgIGxldCBwYXJhbWV0ZXJzID0gb3JpZ1BhcmFtcy5tYXAoKHBhcmFtKSA9PiB7XG4gICAgICBpZiAocGFyYW0uaW1wbGljaXRGaWVsZERlY2xhcmF0aW9uKSB7XG4gICAgICAgIHBhcmFtLm5hbWUudGV4dCA9IHBhcmFtLm5hbWUudGV4dC5zdWJzdHJpbmcoMik7XG4gICAgICB9XG4gICAgICByZXR1cm4gdG9TdHJpbmcocGFyYW0pO1xuICAgIH0pO1xuICAgIGxldCBwcmFtTmFtZXMgPSBvcmlnUGFyYW1zLm1hcCgocGFyYW0pID0+IHtcbiAgICAgIHJldHVybiB0b1N0cmluZyhwYXJhbS5uYW1lKTtcbiAgICB9KTtcbiAgICBsZXQgaXNJbml0ID0gbmFtZSA9PT0gXCJjb25zdHJ1Y3RvclwiO1xuICAgIGxldCBhc3NlcnRTdHIgPSBpc0luaXRcbiAgICAgID8gYGFzc2VydChpc051bGwoX19jb250cmFjdCksIFwiY29udHJhY3QgaXMgYWxyZWFkeSBpbml0aWFsaXplZFwiKTtgXG4gICAgICA6IGBhc3NlcnQoIWlzTnVsbChfX2NvbnRyYWN0KSwgXCJjb250cmFjdCBpcyBub3QgaW5pdGlhbGl6ZWRcIik7YDtcbiAgICBsZXQgaXNWb2lkID0gcmV0dXJuVHlwZSA9PT0gXCJ2b2lkXCI7XG4gICAgbGV0IGJvZHkgPSBpc0luaXRcbiAgICAgID8gYF9fY29udHJhY3QgPSBuZXcgJHtDbGFzc0V4cG9ydGVyLmNsYXNzTmFtZX0oJHtwcmFtTmFtZXMuam9pbihcIiwgXCIpfSk7YFxuICAgICAgOiBgJHshaXNWb2lkID8gXCJsZXQgcmVzID0gIFwiIDogXCJcIn1fX2NvbnRyYWN0LiR7bmFtZX0oJHtwcmFtTmFtZXMuam9pbihcbiAgICAgICAgICBcIiwgXCJcbiAgICAgICAgKX0pO2A7XG4gICAgaWYgKGlzSW5pdCkge1xuICAgICAgbmFtZSA9IFwiaW5pdFwiO1xuICAgICAgcGFyYW1ldGVycyA9IG9yaWdQYXJhbXMubWFwKFxuICAgICAgICAobm9kZSkgPT5cbiAgICAgICAgICBgJHt0b1N0cmluZyhub2RlLm5hbWUpfTogJHt0b1N0cmluZyhub2RlLnR5cGUpfSR7XG4gICAgICAgICAgICBub2RlLmluaXRpYWxpemVyID8gXCIgPSBcIiArIHRvU3RyaW5nKG5vZGUuaW5pdGlhbGl6ZXIpIDogXCJcIlxuICAgICAgICAgIH1gXG4gICAgICApO1xuICAgICAgcmV0dXJuVHlwZSA9IFwidm9pZFwiO1xuICAgIH1cbiAgICBpZiAoaXNJbml0KSB7XG4gICAgICBpZiAoIWRlY29yYXRvcnMuc29tZSgoZGVjb3JhdG9yKSA9PiBkZWNvcmF0b3IuaW5jbHVkZXMoXCJleHBvcnRBc1wiKSkpIHtcbiAgICAgICAgZGVjb3JhdG9ycy5wdXNoKGBAZXhwb3J0QXMoXCJuZXdcIilgKTtcbiAgICAgICAgdGhpcy5jaGVja01ldGhvZHMoXCJuZXdcIik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgZGVjb3JhdG9yID0gbm9kZS5kZWNvcmF0b3JzIS5maW5kKFxuICAgICAgICAgIChkKSA9PiB0b1N0cmluZyhkLm5hbWUpID09PSBcImV4cG9ydEFzXCJcbiAgICAgICAgKSE7XG4gICAgICAgIGlmIChkZWNvcmF0b3IuYXJncyEubGVuZ3RoID09IDEpIHtcbiAgICAgICAgICB0aGlzLmNoZWNrTWV0aG9kcyh0b1N0cmluZyhkZWNvcmF0b3IuYXJncyFbMF0pKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBoYXNVcGRhdGVTdGF0ZSA9IGRlY29yYXRvcnMuc29tZSgoZGVjb3JhdG9yKSA9PiB7XG4gICAgICBsZXQgcmVzID0gZGVjb3JhdG9yLmluY2x1ZGVzKFwidXBkYXRlU3RhdGVcIik7XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH1cbiAgICApO1xuICAgIHRoaXMuc2IucHVzaChcbiAgICAgIGAke2RlY29yYXRvcnMuam9pbihcIlxcblwiKX1cbmV4cG9ydCBmdW5jdGlvbiAke25hbWV9KCR7cGFyYW1ldGVycy5qb2luKFwiLCBcIil9KTogJHtyZXR1cm5UeXBlfSB7XG4gICR7YXNzZXJ0U3RyfVxuICAke2JvZHl9XG4gICR7aXNJbml0IHx8IGhhc1VwZGF0ZVN0YXRlID8gYF9fc2V0U3RhdGUoX19jb250cmFjdCk7YCA6IFwiXCJ9XG4gICR7aXNWb2lkIHx8IGlzSW5pdCA/IFwiXCIgOiBcInJldHVybiByZXM7XCJ9XG59YFxuICAgICk7XG4gIH1cblxuICB2aXNpdENsYXNzRGVjbGFyYXRpb24obm9kZTogQ2xhc3NEZWNsYXJhdGlvbik6IHZvaWQge1xuICAgIGlmIChpc0VudHJ5KG5vZGUpICYmIG5vZGUuaXMoQ29tbW9uRmxhZ3MuRVhQT1JUKSkge1xuICAgICAgbGV0IG5hbWUgPSB0b1N0cmluZyhub2RlLm5hbWUpO1xuICAgICAgaWYgKENsYXNzRXhwb3J0ZXIuY2xhc3NTZWVuKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGV4cG9ydCBjbGFzcyAke25hbWV9LiAke0NsYXNzRXhwb3J0ZXIuY2xhc3NOYW1lfSBhbHJlYWR5IGV4cG9ydGVkLiBgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBDbGFzc0V4cG9ydGVyLmNsYXNzU2VlbiA9IG5vZGU7XG4gICAgICB0aGlzLnNiLnB1c2goXG4gICAgICAgIGBsZXQgX19jb250cmFjdDogJHtuYW1lfTtcbmlmIChfX2NoZWNrU3RhdGUoKSkge1xuICBfX2NvbnRyYWN0ID0gX19nZXRTdGF0ZTwke25hbWV9PigpO1xufWBcbiAgICAgICk7XG4gICAgICB0aGlzLnZpc2l0KG5vZGUubWVtYmVycyk7XG4gICAgICBub2RlLmZsYWdzID0gbm9kZS5mbGFncyBeIENvbW1vbkZsYWdzLkVYUE9SVDtcbiAgICAgIGxldCBuZXdTdGF0ZW1lbnRzID0gU2ltcGxlUGFyc2VyLnBhcnNlVG9wTGV2ZWwodGhpcy5zYi5qb2luKFwiXFxuXCIpKS5tYXAoXG4gICAgICAgIChuKSA9PiB7XG4gICAgICAgICAgaWYgKG4gaW5zdGFuY2VvZiBGdW5jdGlvbkRlY2xhcmF0aW9uKSB7XG4gICAgICAgICAgICBuLmZsYWdzID0gbi5mbGFncyB8IENvbW1vbkZsYWdzLkVYUE9SVDtcbiAgICAgICAgICAgIG4uZmxhZ3MgPSBuLmZsYWdzIHwgQ29tbW9uRmxhZ3MuTU9EVUxFX0VYUE9SVDtcbiAgICAgICAgICB9XG4gICAgICAgICAgbi5yYW5nZSA9IG5vZGUucmFuZ2U7XG4gICAgICAgICAgcmV0dXJuIG47XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICBub2RlLnJhbmdlLnNvdXJjZS5zdGF0ZW1lbnRzLnB1c2goLi4ubmV3U3RhdGVtZW50cyk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IG5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gXCJuZWFyQmluZGdlblwiO1xuICB9XG5cbiAgc3RhdGljIHZpc2l0KHNvdXJjZTogU291cmNlKTogdm9pZCB7XG4gICAgaWYgKHNvdXJjZS5zb3VyY2VLaW5kICE9IFNvdXJjZUtpbmQuVVNFUl9FTlRSWSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgdmlzaXRvciA9IG5ldyBDbGFzc0V4cG9ydGVyKCk7XG4gICAgdmlzaXRvci52aXNpdChzb3VyY2UpO1xuICB9XG59XG4iXX0=